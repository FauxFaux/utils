Index: fldb
===================================================================
--- fldb	(revisjon 2304)
+++ fldb	(arbeidskopi)
@@ -35,6 +35,7 @@
     'crc32' => 0,
     'database' => $STD_DATABASE,
     'debug' => 0,
+    'description' => "",
     'files-from' => "",
     'help' => 0,
     'short-format' => 0,
@@ -61,6 +62,7 @@
     "crc32" => \$Opt{'crc32'},
     "database|d=s" => \$Opt{'database'},
     "debug" => \$Opt{'debug'},
+    "description|D=s" => \$Opt{'description'},
     "files-from|f=s" => \$Opt{'files-from'},
     "help|h" => \$Opt{'help'},
     "short-format|s" => \$Opt{'short-format'},
@@ -177,6 +179,10 @@
             $base_filename =~ s/^.*\/(.*?)$/$1/;
             D("base_filename = '$base_filename'");
             if ($Opt{'xml'}) {
+                my $descr_str = length($Opt{'description'})
+                    ? "<descr>" . txt_to_xml($Opt{'description'}) . "</descr> "
+                    : "";
+                D("descr_str = \"$descr_str\"");
                 if ($Opt{'short-format'}) {
                     # {{{
                     $Retval = sprintf(
@@ -187,6 +193,7 @@
                             "%s" . # $crc32_str
                             "<name>%s</name> " .
                             "<date>%s</date> " .
+                            "%s" . # $descr_str
                             "%s" . # $latin_str
                         "</file>\n",
                         $Size,
@@ -195,6 +202,7 @@
                         $crc32_str,
                         $safe_filename,
                         $Mtime,
+                        $descr_str,
                         $latin1_str,
                     );
                     # }}}
@@ -208,6 +216,7 @@
                             "%s" . # $crc32_str
                             "<filename>%s</filename> " .
                             "<mtime>%s</mtime> " .
+                            "%s" .
                             "<ctime>%s</ctime> " .
                             "<path>%s</path> " .
                             "<inode>%s</inode> " .
@@ -219,7 +228,6 @@
                             "<perm>%s</perm> " .
                             # "<lastver>%s</lastver> " .
                             # "<nextver>%s</nextver> " .
-                            # "<descr>%s</descr> " .
                             "%s" . # $latin1_str
                             "<calctime>%s</calctime> " .
                         "</file>\n",
@@ -229,6 +237,7 @@
                         $crc32_str,
                         $base_filename,
                         $Mtime,
+                        $descr_str,
                         $Ctime,
                         $safe_filename,
                         $Inode,
@@ -240,28 +249,34 @@
                         $Mode,
                         # "",
                         # "",
-                        # "",
                         $latin1_str,
                         $Sum{calctime},
                     );
                     # }}}
                 }
             } else {
+                my $descr_str = length($Opt{'description'})
+                    ? "E'" . safe_sql($Opt{'description'}) . "'"
+                    : "NULL";
+                D("descr_str = \"$descr_str\"");
                 if ($Opt{'short-format'}) {
                     # {{{
                     $Retval = sprintf(<<END,
 INSERT INTO files (
  sha1, md5, crc32,
  size, filename, mtime,
+ descr,
  latin1
 ) VALUES (
  '%s', '%s', %s,
  %s, E'%s', '%s',
+ %s,
  %s
 );
 END
                         $Sum{sha1}, $Sum{md5}, $crc32_str,
                         $Size, $base_filename, $Mtime,
+                        $descr_str,
                         $latin1_str,
                     );
                     # }}}
@@ -270,7 +285,7 @@
                     $Retval = sprintf(<<END,
 INSERT INTO files (
  sha1, md5, crc32,
- size, filename, mtime, ctime,
+ size, filename, mtime, descr, ctime,
  calctime, path,
  inode, links, device, hostname,
  uid, gid, perm,
@@ -278,7 +293,7 @@
  latin1
 ) VALUES (
  '%s', '%s', %s,
- %s, E'%s', '%s', '%s',
+ %s, E'%s', %s, '%s',
  %s, E'%s',
  %s, %s, E'%s', E'%s',
  %s, %s, '%s',
@@ -287,7 +302,7 @@
 );
 END
                         $Sum{sha1}, $Sum{md5}, $crc32_str,
-                        $Size, $base_filename, $Mtime, $Ctime,
+                        $Size, $base_filename, $Mtime, $descr_str, $Ctime,
                         $Sum{calctime}, $safe_filename,
                         $Inode, $Nlinks, safe_sql($Dev), $safe_hostname,
                         $Uid, $Gid, $Mode,
@@ -361,6 +376,8 @@
   --crc32
     Also calculate CRC32. Reads the whole file into memory, so itâ€™s not 
     suitable for big files. Maybe fixed in newer Perl versions.
+  -D x, --description x
+    Use x as file description.
   -d x, --database x
     Use database x.
   -h, --help
