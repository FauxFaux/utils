#!/usr/bin/perl -w

# $Id: gptrans_conv,v 1.4 2003/04/24 18:51:22 sunny Exp $

use strict;
use utf8;
use Getopt::Std;
use Time::Local qw { timegm_nocheck };

our ($opt_h, $opt_p) = (0, 0);
getopts('hp');

if ($opt_h) {
	print(<<END);

Syntax: gptrans_conv [-hp] [filer [...]]

-h  Hjælp mæ
-p  Bruk punktum istedenfor komma som desimaltegn

END
	exit(0);
}

my $Des = $opt_p ? "." : ",";

while (<>) {
	if (m#^T\t(..)/(..)/(....) (..):(..):(..)\t(.+)\xB0(.+)'(.+)"\t(.+)\xB0(.+)'(.+)"#) {
		# T	09/01/2002 11:51:26	60°23'36.3"	5°19'35.9"
		my ($Month, $Day, $Year, $Hour, $Min, $Sec, $lon_d, $lon_m, $lon_s, $lat_d, $lat_m, $lat_s) = ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12);
		my $lon_val = sprintf("%.5f", 1*($lon_d+($lon_m/60)+($lon_s/3600)));
		my $lat_val = sprintf("%.5f", $lat_d+($lat_m/60)+($lat_s/3600));
		my $ep_time = timegm_nocheck($Sec, $Min, $Hour, $Day, $Month-1, $Year);
		$lon_val =~ s/\./$Des/;
		$lat_val =~ s/\./$Des/;
		print("$ep_time\t$lat_val\t$lon_val\t?\t?\n");
		# print("$Year-$Month-$Day $Hour:$Min:$Sec\t$lat_val\t$lon_val\n");
		# print("$lon_val\t$lat_val\n");
	} elsif (m#^1 (\S+) (\S+) (\S+) (\S+) (..)/(..)/(....) (..):(..):(..)#) {
		# 1 60.3938222 5.3238754 17.3 0 09/01/2002 14:18:23
		my ($lon_val, $lat_val, $Speed, $Unkn, $Month, $Day, $Year, $Hour, $Min, $Sec) = ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10);
		my $ep_time = timegm_nocheck($Sec, $Min, $Hour, $Day, $Month-1, $Year);
		$lon_val =~ s/\./$Des/;
		$lat_val =~ s/\./$Des/;
		print("$ep_time\t$lat_val\t$lon_val\t?\t$Speed\n");
		# print("$Year-$Month-$Day $Hour:$Min:$Sec\t$lat_val\t$lon_val\n");
	} elsif (/^xmaplog /) {
	} else {
		warn("Linje $.: Ukjent: \"$_\"");
	}
}
